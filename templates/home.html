<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Drug Discovery V2.1</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script> 

    <style>
        body { background-color: #f4f7f6; padding-bottom: 50px; }
        .container { max-width: 1200px; background: white; padding: 30px; margin-top: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .viewer_3d { width: 100%; height: 400px; position: relative; background: #eef; border-radius: 10px; margin-top: 20px; border: 1px solid #ddd; }
        .badge-novel { background-color: #6f42c1; color: white; } 
        .badge-known { background-color: #0d6efd; color: white; }
    </style>
</head>
<body>

    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0">üß¨ AI Drug Discovery Pipeline</h1>
                <p class="text-muted">Screen novel candidates against any PDB Target.</p>
            </div>
            <div class="col-md-4 text-end">
                 <form action="/" method="POST" class="d-flex">
                    <input type="text" class="form-control me-2" name="pdb_id" placeholder="PDB ID (e.g. 4ZAO)" required value="{{ pdb_id if pdb_id else '' }}">
                    <button type="submit" class="btn btn-primary">Screen</button>
                </form>
            </div>
        </div>

        {% if error %}
        <div class="alert alert-danger mt-3">{{ error }}</div>
        {% endif %}

        {% if results %}
        <div class="row mt-4">
            <div class="col-md-5">
                <div class="card p-3 shadow-sm">
                    <h5 class="text-center">Target Protein: <span class="text-primary fw-bold">{{ pdb_id }}</span></h5>
                    
                    <div id="container-01" class="viewer_3d"></div>
                    
                    <div class="text-center mt-2">
                        <small class="text-muted">üñ±Ô∏è Left Click: Rotate | üñ±Ô∏è Scroll: Zoom</small>
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>üèÜ Top Candidates</h3>
                    <button class="btn btn-sm btn-outline-success" onclick="window.print()">Download Report</button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Rank</th>
                                <th>Molecule</th>
                                <th>Status</th>
                                <th>Potency</th>
                                <th>Violations</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in results %}
                            <tr>
                                <td><strong>#{{ loop.index }}</strong></td>
                                <td>
                                    <img src="data:image/png;base64,{{ row['Image_Base64'] }}" width="100" style="border-radius:5px;">
                                </td>
                                <td>
                                    {% if row['Status'] == 'Novel Candidate' %}
                                        <span class="badge badge-novel">Novel ‚ú®</span>
                                    {% else %}
                                        <span class="badge badge-known">Known üíä</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="fw-bold text-success">{{ "%.2f"|format(row['Predicted_pIC50']) }}</div>
                                    <small class="text-muted">{{ row['IC50_nM'] }} nM</small>
                                </td>
                                <td>
                                    {% if row['Violations'] == 0 %}
                                        <span class="badge bg-success">0 (Safe)</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">{{ row['Violations'] }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ row['Search_Link'] }}" target="_blank" class="btn btn-sm btn-outline-primary">üîç Check</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            $(document).ready(function() {
                let element = $('#container-01');
                let config = { backgroundColor: '#f0f2f5' };
                let viewer = $3Dmol.createViewer( element, config );
                
                // Fetch PDB Data from RCSB
                let pdbUri = "https://files.rcsb.org/view/{{ pdb_id }}.pdb";
                
                $.ajax({
                    url: pdbUri,
                    success: function( data ) {
                        viewer.addModel( data, "pdb" );                       
                        viewer.setStyle({}, {cartoon: {color: 'spectrum'}});  
                        viewer.zoomTo();                                      
                        viewer.render();                                      
                    },
                    error: function( hdr, status, err ) {
                        $('#container-01').html('<div class="alert alert-warning">Could not load 3D Structure. (Network Error or Invalid ID)</div>');
                    }
                });
            });
        </script>
        {% endif %}
    </div>

</body>
</html>